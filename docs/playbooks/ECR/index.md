---
layout: default
---

AWS EC2 Container Repository
====
<!-- Table of contents generated generated by http://tableofcontent.eu -->
- [Alerts](#alerts)
- [ECRs](#ecrs)
- [General AWS service dashboard](#general-aws-service-dashboard)
- [General Healthcheck](#general-healthcheck)
    - [Test push](#test-push)
    - [Test pull](#test-pull)
- [Amazon Support](#amazon-support)
- [Notification](#notification)


----------

This is a playbook for Quantum team members and guests who have knowledge and training on how to perform this work.  We expect to place here code/examples/policies or other information that we find useful to maintaining our services.  If you're an end user of the service you might be happier to read the user guides instead of this document. General information on how to use the ECR is available in the [ECR User Guide](../../guides/container_repository/index.md).

Our team does not currently do any setup to enable the ECR in an account/region.  It ships with AWS by default.  This may change if/when we move from many little ECRs to one consolidated account.  Most users need to be set up with permissions to use the ECR.  This is covered in more detail in [UserPermissions](../IT-AWS/UserPermissions/index.md).

Developers invited to an account should have access to the repo.

Service accounts must be given this permission explicitly.  See the playbooks on user permissions for more details.


----------


# Alerts

| Alert                      |Description                                                                         |
|:---------------------------|:------------------------------------------------------------------------------------|
|All Alerts|Check the [HPID ECR dashboard](https://dashboard.id.hpcwp.com/dashboard/db/aws-ecr) and [AWS status page](#general-aws-service-dashboard) and [HPID ALL dashboard](https://dashboard.id.hpcwp.com/dashboard/db/all-services)|
|HealthStatus|An ECR login, push, or pull failed on the exporter|
|HighLatency|An ECR push or pull took longer than 10 seconds on the exporter|
|RepoCount|More than 900 repos have been registered in an ECR region/account|

## All Alerts

 - View the HPID ECR Grafana [dashboard](https://dashboard.id.hpcwp.com/dashboard/db/aws-ecr) to determine the region and account of the alert
 - View the [AWS status page](#general-aws-service-dashboard) to see if Amazon already knows about an outage
 - View the [HPID ALL Services dashbaord](https://dashboard.id.hpcwp.com/dashboard/db/all-services)

## HealthStatus

Perform a [manual push / pull](#general-health-check) to the affected region/acct
 - If this fails, contact [Amazon Support](#amazon-support) and send a [notification](#notification) to users
 - If this succeeds, this may indicate a problem with the exporter

## HighLatency

Perform a [manual push / pull](#general-health-check) to the affected region/acct and time the results
 - If times are more than 10 seconds, contact [Amazon Support](#amazon-support) and send a [notification](#notification) to users
 - If this succeeds, this may indicate a problem with the exporter

## RepoCount

Log in to the AWS Web Console, go to EC2 Container Service, click [Repositories](https://us-west-2.console.aws.amazon.com/ecs/home?region=us-west-2#/repositories), and try to identify who/what is creating so many repos so you can ask them to stop
 - Note that the Filter only applies to the currently-displayed page of repos, so it will be necessary to page through all pages to see all of them

----------


# ECR Repos

6 supported at the moment, one in each AWS IT account in us-west-2 primarily with a few images in us-east-1 as well. An example of where they're located:

https://us-west-2.console.aws.amazon.com/ecs/home?region=us-west-2#/repositories

* hp-id-dev (871386769552)
* hpid-cd-dev (120744138334)
* hpid-prod-pro (872569379934)

The registry lives at a well known pattern:
`#{account_number}.dkr.ecr.#{region}.amazonaws.com/#{repo_name}`

Team members who need to manage an ECR can do so with their AWS account credentials. (The STS login for gui access, or aws-it-login tool to get CLI access).

## Useful links
* [AWS Login page](https://sts.corp.hpicloud.net/adfs/ls/idpinitiatedsignon.aspx)
* [Propel](https://propel-pro.houston.hp.com)

# HPID Dashboard for ECR

[Our dashboard](https://dashboard.id.hpcwp.com/dashboard/db/aws-ecr)

# General AWS service dashboard

[Amazon Service Health Dashboard](https://status.aws.amazon.com/)

Search for "Amazon EC2 Container Registry" and the correct region

# HPID All Service dashboard
[HPID Serivces](https://dashboard.id.hpcwp.com/dashboard/db/all-services)

----------


# General health check

### ECR playbook container

The steps below require the docker container in the gcd-quantum repository [HERE](./docker).

### Test push

1. Vagrant ssh to gcd-devenv
2. Log in to AWS (TODO: Add link to basic steps)
3. Get docker login
	 - `aws --profile saml ecr get-login --region [region]`
4. Log in to ECR
	 - `docker login -u AWS -p [redacted] -e none https://[acct].dkr.ecr.[region].amazonaws.com`
5. Create repository
	 - `aws ecr create-repository --profile saml --region [region] --repository-name quantum/ecr-playbook`
6. Build ecr-playbook container (if needed)
	 - `docker build -t quantum/ecr-playbook .`
7. Tag
	 - `docker tag quantum/ecr-playbook:latest [acct].dkr.ecr.[region].amazonaws.com/quantum/ecr-playbook:latest`
8. Push
	 - `docker push [acct].dkr.ecr.[region].amazonaws.com/quantum/ecr-playbook:latest`
	 - If fails to push with 'no basic auth' go back a few steps and run 'Get docker login' and 'Log in to ECR'

### Test pull

1. Delete locally (if needed)
	 - `docker image rm [acct].dkr.ecr.[region].amazonaws.com/quantum/ecr-playbook/ecr-playbook`
2. Pull
	 - `docker pull [acct].dkr.ecr.[region].amazonaws.com/quantum/ecr-playbook/ecr-playbook`

# Amazon support

If the service is failing to work for the general health check, you might need to open a ticket with Amazon:

1. Log in to HP IT AWS in a browser.
2. Select ADMIN for the correct account.
3. At the top right corner in **Support** drop down, select **Support Center**.
4. Select **Create case**.
     - Add quantum@groups.hp.com and quantum-notifications-hipchat@external.groups.hp.com in the CC field.
     - Service is "Container Service."
     - Category is "Container registry."<br/>
       In some cases this may change.
     - Fill in the rest of the information including results of the health check steps.

# Notification

## Email

When deemed to be an actual outage, send the following template to CWP_Global, [cwp-sre-maint-hpid@external.groups.hp.com](cwp-sre-maint-hpid@external.groups.hp.com);

Create email with the following [template](https://hp.sharepoint.com/teams/cwp-set/Shared%20Documents/Templates/HPID_outage_notification_template.docx?d=w824f50119587412aaf4f2283de52b099).

## Chat Channels
* [CWP Quantum Team](https://hpi-cso-jira-hipchat.hipchat.com/chat/room/3475105)
* [CWP Eng Internal](https://hpi-cso-jira-hipchat.hipchat.com/chat/room/3504977)
* [CWP Eng General Chat](https://hpi-cso-jira-hipchat.hipchat.com/chat/room/3504662)
* [GCD Forum](https://hpi-cso-jira-hipchat.hipchat.com/chat/room/3669983)



